<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EIHO Admin</title>
  <style>
    :root{
      --brand:#0f5ea6;
      --brand-dark:#0b4b85;
      --bg-soft:#f4f7fc;
      --text:#1f2a37;
      --muted:#64748b;
      --card:#ffffff;
      --border:#e6ebf3;
      --field:#d6dbe6;
    }
    *{box-sizing:border-box;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1100px 400px at -8% -20%, rgba(15,94,166,.14), transparent 62%),
        radial-gradient(860px 340px at 108% 112%, rgba(61,134,209,.12), transparent 60%),
        linear-gradient(180deg,#f6f8fc 0%,#edf2f9 100%);
      margin:0;
      padding:24px;
      color:var(--text);
      overflow-x:hidden;
      position:relative;
      isolation:isolate;
    }
    .network-canvas{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      z-index:0;
      pointer-events:none;
      opacity:.58;
    }
    .bg-wave{
      position:fixed;
      inset:-18%;
      pointer-events:none;
      z-index:0;
      opacity:.2;
      background:
        radial-gradient(1300px 260px at 20% 26%, rgba(132,173,223,.28), transparent 70%),
        radial-gradient(1100px 240px at 75% 72%, rgba(109,166,230,.25), transparent 70%);
      animation:bg-wave 22s linear infinite;
    }
    @keyframes bg-wave{
      0%{transform:translateX(0) translateY(0);}
      50%{transform:translateX(-2.5%) translateY(1.5%);}
      100%{transform:translateX(0) translateY(0);}
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      max-width:1200px;
      margin:0 auto 14px;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(255,255,255,.88);
      -webkit-backdrop-filter:blur(6px);
      backdrop-filter:blur(6px);
      box-shadow:0 10px 28px rgba(20,37,63,.07);
      position:relative;
      z-index:1;
    }
    .top-title{margin:0;font-size:24px;line-height:1.2;font-weight:900;letter-spacing:.2px;}
    .top-sub{margin:4px 0 0;color:var(--muted);font-size:13px;}
    .top-links{display:flex;align-items:center;gap:8px;white-space:nowrap;}
    .top-links .dot{color:#9aa8bb;}
    .wrap{max-width:1200px;margin:0 auto;position:relative;z-index:1;}
    .card{
      background:var(--card);
      border-radius:18px;
      padding:18px;
      box-shadow:0 20px 50px rgba(16,31,56,.08);
      border:1px solid var(--border);
    }
    .card-title{margin:0 0 8px;font-size:18px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .full{grid-column:1/-1;}
    .section{
      border:1px solid var(--border);
      border-radius:16px;
      margin-bottom:16px;
      background:var(--card);
      box-shadow:0 8px 26px rgba(31,42,55,.04);
      overflow:hidden;
    }
    .section summary{
      cursor:pointer;
      font-weight:800;
      font-size:16px;
      padding:14px 16px;
      list-style:none;
      background:linear-gradient(180deg,#f9fbff 0%,#f3f7fd 100%);
      border-bottom:1px solid var(--border);
    }
    .section summary::-webkit-details-marker{display:none;}
    .section-body{padding:2px 16px 16px;}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:0;}
    label{font-weight:700;color:#273244;font-size:13px;}
    input,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--field);
      border-radius:12px;
      margin-top:6px;
      background:#fff;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input:focus,textarea:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(15,94,166,.12);
    }
    textarea{min-height:92px;resize:vertical;}
    textarea.textarea-tall{min-height:160px;}
    .form-actions{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-start;
      position:sticky;
      bottom:14px;
      z-index:3;
      background:rgba(255,255,255,.9);
      -webkit-backdrop-filter:blur(6px);
      backdrop-filter:blur(6px);
      box-shadow:0 14px 30px rgba(31,42,55,.08);
    }
    .save-btn{
      min-width:94px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .save-btn[disabled]{
      opacity:.78;
      cursor:not-allowed;
      box-shadow:none;
    }
    .save-note{color:#5f6d82;font-size:12px;}
    .btn{
      padding:10px 14px;
      border:0;
      border-radius:12px;
      background:linear-gradient(135deg,var(--brand) 0%,#2d79c5 100%);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      transition:transform .06s ease,box-shadow .2s ease, background .2s ease;
    }
    .btn:hover{
      background:linear-gradient(135deg,var(--brand-dark) 0%,var(--brand) 100%);
      box-shadow:0 8px 20px rgba(15,94,166,.25);
    }
    .btn:active{transform:translateY(1px);}
    .btn.disabled{
      opacity:.6;
      pointer-events:none;
      box-shadow:none;
    }
    .btn-outline{background:#fff;color:var(--brand);border:1px solid var(--brand);}
    .btn-outline:hover{color:#fff;}
    .btn-danger{background:#fff;color:#c62828;border:1px solid #c62828;}
    .btn-danger:hover{background:#c62828;color:#fff;box-shadow:none;}
    .hint{color:#5f6d82;font-size:12px;margin-top:4px;}
    a{color:var(--brand);text-decoration:none;font-weight:700;}
    a:hover{text-decoration:underline;}
    .item-row{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      background:linear-gradient(180deg,#fbfdff 0%,#f8fbff 100%);
    }
    .item-fields{display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px;}
    .item-fields.compact{grid-template-columns:1fr 1fr 2fr;}
    .item-fields.simple{grid-template-columns:1fr 2fr;}
    .item-fields.one{grid-template-columns:1fr;}
    .item-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px;}
    .item-actions .btn{padding:6px 10px;font-weight:700;}
    .subpage-hint{
      margin-top:8px;
      padding:8px 10px;
      border:1px dashed #cddcf3;
      border-radius:10px;
      background:#f8fbff;
      font-size:12px;
      color:#4b5b70;
    }
    .news-wrap{margin-top:18px;}
    .news-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;color:#6b7280;}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3f51b5;font-weight:700;font-size:11px;}
    .news-panel{border:1px solid #dce6f6;border-radius:14px;background:#f8fbff;padding:12px;margin-top:10px;box-shadow:0 8px 24px rgba(31,42,55,.03);}
    .news-panel-title{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .news-panel-title h4{margin:0;font-size:17px;}
    .news-create{background:#fff;border:1px solid #dfe7f3;}
    .news-create-title{margin:0 0 4px;font-size:18px;color:#1f2a37;}
    .news-create-subtitle{margin:0 0 12px;color:#667085;font-size:13px;}
    .news-create-grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;}
    .news-main-fields{display:grid;grid-template-columns:1fr;gap:12px;}
    .news-side-panel{display:grid;grid-template-columns:1fr;gap:10px;align-content:start;}
    .news-editor-tools{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-start;
    }
    .news-editor-tools .btn{padding:5px 9px;font-weight:700;}
    .news-preview{
      margin-top:8px;
      border:1px solid #dce6f6;
      border-radius:12px;
      background:#f9fbff;
      padding:10px;
    }
    .news-preview-title{
      margin:0 0 6px;
      font-size:12px;
      color:#4f6078;
      font-weight:800;
      letter-spacing:.2px;
    }
    .news-preview-box{
      border:1px dashed #cad8ec;
      border-radius:10px;
      background:#fff;
      padding:10px;
      min-height:62px;
      display:grid;
      gap:8px;
      color:#344054;
      font-size:13px;
      line-height:1.75;
    }
    .news-preview-empty{color:#94a3b8;}
    .news-preview-h2{
      margin:0;
      font-size:14px;
      font-weight:800;
      color:#0b3b66;
      border-left:3px solid #0f5ea6;
      padding-left:8px;
    }
    .news-preview-note{
      border:1px solid rgba(15,94,166,.2);
      background:rgba(15,94,166,.06);
      color:#154b7d;
      border-radius:8px;
      padding:8px;
      margin:0;
      white-space:pre-wrap;
    }
    .news-preview-list{margin:0;padding-left:18px;display:grid;gap:4px;}
    .news-preview-img{
      border:1px solid #d7e3f5;
      border-radius:8px;
      background:linear-gradient(180deg,#f8fbff,#eef4fb);
      color:#4a5f7c;
      padding:8px;
      font-size:12px;
      font-weight:700;
    }
    .news-upload-card{
      border:1px solid #dbe5f3;
      border-radius:10px;
      background:#f9fbff;
      padding:10px;
    }
    .news-upload-card label{display:block;margin-bottom:4px;}
    .news-publish-check{display:flex;align-items:center;gap:6px;font-size:13px;color:#374151;margin-top:6px;}
    .news-publish-check input[type="checkbox"]{width:auto;margin:0;}
    .news-create .item-actions{margin-top:12px;justify-content:flex-start;}
    .news-list-wrap{display:grid;gap:10px;}
    .news-item{background:#fff;border:1px solid #dfe7f3;}
    .news-item-grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:8px;}
    .news-side-fields{display:grid;gap:10px;align-content:start;}
    .news-publish-inline{display:flex;align-items:center;gap:6px;font-size:13px;color:#374151;margin-top:6px;}
    .news-publish-inline input[type="checkbox"]{width:auto;margin:0;}
    .news-item .item-actions{border-top:1px solid #eef2f8;padding-top:10px;margin-top:10px;}
    .news-filter-form{margin-top:8px;}
    .news-status-select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--field);
      border-radius:12px;
      margin-top:6px;
      background:#fff;
    }
    .news-filter-actions{
      justify-content:flex-start;
      margin-top:0;
    }
    .news-pager{
      justify-content:center;
      margin-top:12px;
    }
    .inline-marker-actions{
      justify-content:flex-start;
      margin-top:6px;
    }
    .toast-stack{
      position:fixed;
      right:14px;
      bottom:14px;
      z-index:1200;
      display:grid;
      gap:8px;
      width:min(360px, calc(100vw - 28px));
    }
    .toast-msg{
      border-radius:12px;
      border:1px solid rgba(15,94,166,.2);
      background:rgba(255,255,255,.94);
      -webkit-backdrop-filter:blur(8px);
      backdrop-filter:blur(8px);
      box-shadow:0 12px 26px rgba(31,42,55,.14);
      padding:8px 10px;
      font-size:12px;
      line-height:1.45;
      color:#253246;
      transform:translateY(10px);
      opacity:0;
      animation:toast-in .18s ease forwards;
    }
    .toast-msg.ok{
      border-color:rgba(22,163,74,.28);
      background:rgba(236,253,245,.95);
    }
    .toast-msg.err{
      border-color:rgba(220,38,38,.3);
      background:rgba(254,242,242,.95);
    }
    .toast-title{
      font-weight:800;
      margin:0 0 2px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .toast-title i{font-size:12px;}
    .toast-body{margin:0;color:#405066;word-break:break-word;}
    @keyframes toast-in{
      from{transform:translateY(10px);opacity:0;}
      to{transform:translateY(0);opacity:1;}
    }
    @media (max-width: 900px){
      body{padding:14px;}
      .top{padding:12px;}
      .top-title{font-size:20px;}
      .top-links{font-size:13px;}
      .grid{grid-template-columns:1fr;}
      .item-fields,.item-fields.compact,.item-fields.simple{grid-template-columns:1fr;}
      .news-create-grid{grid-template-columns:1fr;}
      .news-item-grid{grid-template-columns:1fr;}
      .form-actions{position:static;}
    }
    @media (prefers-reduced-motion: reduce){
      .bg-wave{animation:none;}
    }
  </style>
</head>
<body>
  <canvas id="networkCanvas" class="network-canvas" aria-hidden="true"></canvas>
  <div class="bg-wave" aria-hidden="true"></div>
  <div class="top">
    <div>
      <h2 class="top-title">主页内容管理</h2>
      <p class="top-sub">统一维护导航、内容模块、新闻与公司信息。</p>
    </div>
    <div class="top-links">
      <a href="/api/public/home" target="_blank">查看 public JSON</a>
      <span class="dot">|</span>
      <a href="/admin/logout">退出</a>
    </div>
  </div>

  <div class="wrap">
    <form method="post" action="/admin/save">
      <details class="section" open>
        <summary><span class="section-title">导航栏</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="nav_brand_text">品牌文字</label>
              <input id="nav_brand_text" name="nav_brand_text" value="{{ home.nav_brand_text or '' }}" placeholder="EIHO / 衛宝">
            </div>
            <div>
              <label for="nav_top_text">顶部</label>
              <input id="nav_top_text" name="nav_top_text" value="{{ home.nav_top_text or '' }}" placeholder="トップ">
            </div>
            <div>
              <label for="nav_concept_text">メッセージ</label>
              <input id="nav_concept_text" name="nav_concept_text" value="{{ home.nav_concept_text or '' }}" placeholder="メッセージ">
            </div>
            <div>
              <label for="nav_news_text">ニュース</label>
              <input id="nav_news_text" name="nav_news_text" value="{{ home.nav_news_text or '' }}" placeholder="ニュース">
            </div>
            <div>
              <label for="nav_services_text">事業内容</label>
              <input id="nav_services_text" name="nav_services_text" value="{{ home.nav_services_text or '' }}" placeholder="事業内容">
            </div>
            <div>
              <label for="nav_strengths_text">強み</label>
              <input id="nav_strengths_text" name="nav_strengths_text" value="{{ home.nav_strengths_text or '' }}" placeholder="強み">
            </div>
            <div>
              <label for="nav_profile_text">会社概要</label>
              <input id="nav_profile_text" name="nav_profile_text" value="{{ home.nav_profile_text or '' }}" placeholder="会社概要">
            </div>
            <div>
              <label for="nav_cta_text">CTA</label>
              <input id="nav_cta_text" name="nav_cta_text" value="{{ home.nav_cta_text or '' }}" placeholder="お問合わせ">
            </div>
          </div>
        </div>
      </details>

      <details class="section" open>
        <summary><span class="section-title">Hero / 顶部</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="hero_kicker">Hero 角标</label>
              <input id="hero_kicker" name="hero_kicker" value="{{ home.hero_kicker or '' }}" placeholder="Japan × China | Automotive Trading">
            </div>
            <div class="full">
              <label for="hero_title">Hero 标题</label>
              <input id="hero_title" name="hero_title" value="{{ home.hero_title or '' }}" placeholder="例：品質と情熱で、日中のカーライフを繋ぐ架け橋へ">
            </div>
            <div class="full">
              <label for="hero_subtitle">Hero 副文案</label>
              <textarea id="hero_subtitle" name="hero_subtitle" placeholder="例：株式会社衛宝は…">{{ home.hero_subtitle or '' }}</textarea>
            </div>
            <div>
              <label for="hero_primary_cta">主按钮文案</label>
              <input id="hero_primary_cta" name="hero_primary_cta" value="{{ home.hero_primary_cta or '' }}" placeholder="事業内容を見る">
            </div>
            <div>
              <label for="hero_secondary_cta">副按钮文案</label>
              <input id="hero_secondary_cta" name="hero_secondary_cta" value="{{ home.hero_secondary_cta or '' }}" placeholder="会社概要">
            </div>
            <div class="full">
              <label for="hero_bg_image">Hero 背景图（URL 或路径）</label>
              <input id="hero_bg_image" name="hero_bg_image" value="{{ home.hero_bg_image or '' }}" placeholder="https://…">
              <div class="hint">建议用 URL。后续要支持上传图片也可以加接口。</div>
            </div>
          </div>
          <div class="full">
            <h4>Hero 统计卡片（可多条）</h4>
            <div class="hint">每条包含「数字」「后缀」「说明」</div>
            <div id="heroStatsList">
              {% if hero_stats and hero_stats|length > 0 %}
                {% for s in hero_stats %}
                  <div class="item-row">
                    <div class="item-fields compact">
                      <div>
                        <label>数字</label>
                        <input name="hero_stat_value" value="{{ s.value }}" placeholder="2">
                      </div>
                      <div>
                        <label>后缀</label>
                        <input name="hero_stat_suffix" value="{{ s.suffix }}" placeholder="国間">
                      </div>
                      <div>
                        <label>说明</label>
                        <input name="hero_stat_label" value="{{ s.label }}" placeholder="日中の調達・販売を一気通貫">
                      </div>
                    </div>
                    <div class="item-actions">
                      <button type="button" class="btn btn-danger" data-remove>删除</button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="item-row">
                  <div class="item-fields compact">
                    <div>
                      <label>数字</label>
                      <input name="hero_stat_value" value="" placeholder="2">
                    </div>
                    <div>
                      <label>后缀</label>
                      <input name="hero_stat_suffix" value="" placeholder="国間">
                    </div>
                    <div>
                      <label>说明</label>
                      <input name="hero_stat_label" value="" placeholder="日中の調達・販売を一気通貫">
                    </div>
                  </div>
                  <div class="item-actions">
                    <button type="button" class="btn btn-danger" data-remove>删除</button>
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="item-actions">
              <button type="button" class="btn btn-outline" data-add-hero-stat>+ 添加统计卡片</button>
            </div>
          </div>
        </div>
      </details>

      <details class="section">
        <summary><span class="section-title">概念 / Mission / Vision / Value</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="concept_title">区块标题</label>
              <input id="concept_title" name="concept_title" value="{{ home.concept_title or '' }}" placeholder="メッセージ（コンセプト）">
            </div>
            <div class="full">
              <label for="concept_subtitle">区块描述</label>
              <textarea id="concept_subtitle" name="concept_subtitle">{{ home.concept_subtitle or '' }}</textarea>
            </div>
          </div>
          <div class="full">
            <h4>三条要点</h4>
            <div class="hint">每条包含「标题」「说明」</div>
            <div id="conceptPointsList">
              {% if concept_points and concept_points|length > 0 %}
                {% for p in concept_points %}
                  <div class="item-row">
                    <div class="item-fields simple">
                      <div>
                        <label>标题</label>
                        <input name="concept_point_label" value="{{ p.label }}" placeholder="安心">
                      </div>
                      <div>
                        <label>说明</label>
                        <textarea name="concept_point_body" placeholder="検品・規格・品質の可視化">{{ p.body }}</textarea>
                      </div>
                    </div>
                    <div class="item-actions">
                      <button type="button" class="btn btn-danger" data-remove>删除</button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="item-row">
                  <div class="item-fields simple">
                    <div>
                      <label>标题</label>
                      <input name="concept_point_label" value="" placeholder="安心">
                    </div>
                    <div>
                      <label>说明</label>
                      <textarea name="concept_point_body" placeholder="検品・規格・品質の可視化"></textarea>
                    </div>
                  </div>
                  <div class="item-actions">
                    <button type="button" class="btn btn-danger" data-remove>删除</button>
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="item-actions">
              <button type="button" class="btn btn-outline" data-add-concept-point>+ 添加要点</button>
            </div>
          </div>
          <div class="grid">
            <div>
              <label for="mission_title">Mission 标题</label>
              <input id="mission_title" name="mission_title" value="{{ home.mission_title or '' }}" placeholder="Mission">
            </div>
            <div>
              <label for="vision_title">Vision 标题</label>
              <input id="vision_title" name="vision_title" value="{{ home.vision_title or '' }}" placeholder="Vision">
            </div>
            <div>
              <label for="mission_body">Mission 内容</label>
              <textarea id="mission_body" name="mission_body">{{ home.mission_body or '' }}</textarea>
            </div>
            <div>
              <label for="vision_body">Vision 内容</label>
              <textarea id="vision_body" name="vision_body">{{ home.vision_body or '' }}</textarea>
            </div>
            <div>
              <label for="value_title">Value 标题</label>
              <input id="value_title" name="value_title" value="{{ home.value_title or '' }}" placeholder="Value">
            </div>
            <div>
              <label for="value_body">Value 内容</label>
              <textarea id="value_body" name="value_body">{{ home.value_body or '' }}</textarea>
            </div>
            <div>
              <label for="president_message_label">社長メッセージ 标签</label>
              <input id="president_message_label" name="president_message_label" value="{{ home.president_message_label or 'President Message' }}" placeholder="President Message">
            </div>
            <div>
              <label for="president_message_title">社長メッセージ 标题</label>
              <input id="president_message_title" name="president_message_title" value="{{ home.president_message_title or '社長メッセージ' }}" placeholder="社長メッセージ">
            </div>
            <div>
              <label for="president_name">社長姓名（可选）</label>
              <input id="president_name" name="president_name" value="{{ home.president_name or '' }}" placeholder="例：山田 太郎">
            </div>
            <div>
              <label for="president_role">社長职位</label>
              <input id="president_role" name="president_role" value="{{ home.president_role or '' }}" placeholder="株式会社 衛宝（EIHO） 代表取締役">
            </div>
            <div class="full">
              <label for="president_message_body">社長メッセージ 正文</label>
              <textarea id="president_message_body" name="president_message_body">{{ home.president_message_body or '' }}</textarea>
            </div>
            <div class="full">
              <label for="president_message_quote">社長メッセージ 强调语（Quote）</label>
              <textarea id="president_message_quote" name="president_message_quote">{{ home.president_message_quote or '' }}</textarea>
            </div>
            <div class="full">
              <h4>社長メッセージ要点（可多条）</h4>
              <div class="hint">每条将显示为列表要点。</div>
              <div id="presidentPointsList">
                {% if president_points and president_points|length > 0 %}
                  {% for p in president_points %}
                    <div class="item-row">
                      <div class="item-fields one">
                        <div>
                          <label>要点</label>
                          <input name="president_point_text" value="{{ p }}" placeholder="例如：長期的な信頼関係を重視">
                        </div>
                      </div>
                      <div class="item-actions">
                        <button type="button" class="btn btn-danger" data-remove>删除</button>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="item-row">
                    <div class="item-fields one">
                      <div>
                        <label>要点</label>
                        <input name="president_point_text" value="" placeholder="例如：長期的な信頼関係を重視">
                      </div>
                    </div>
                    <div class="item-actions">
                      <button type="button" class="btn btn-danger" data-remove>删除</button>
                    </div>
                  </div>
                {% endif %}
              </div>
              <div class="item-actions">
                <button type="button" class="btn btn-outline" data-add-president-point>+ 添加要点</button>
              </div>
            </div>
          </div>
        </div>
      </details>

      <details class="section" open>
        <summary><span class="section-title">ニュース管理</span></summary>
        <div class="section-body">
          <div class="hint">主页只显示已发布新闻标题，点击进入详情页。</div>
          <div class="news-panel">
            <div class="news-panel-title">
              <h4>新建ニュース</h4>
              <span class="hint">填写完成后点击创建</span>
            </div>
            <div class="item-row news-create" data-news-existing-images="0">
              <p class="news-create-subtitle">先完成标题和正文，再设置图片、附件和发布状态。</p>
              <div class="news-create-grid">
                <div class="news-main-fields">
                  <div>
                    <label>标题</label>
                    <input name="title" placeholder="例：展示会出展のお知らせ" title="新闻标题">
                  </div>
                  <div>
                    <label>正文</label>
                    <textarea name="body" class="textarea-tall" placeholder="这里输入正文内容" title="新闻正文"></textarea>
                    <div class="hint">建议首段概述核心信息，后续分段补充时间、地点、对象与联系方式。</div>
                    <div class="hint">支持文本结构：<code>[h2]小标题[/h2]</code>、<code>[note]强调[/note]</code>、<code>[ul]要点1|要点2[/ul]</code>。</div>
                    <div class="news-editor-tools">
                      <button type="button" class="btn btn-outline" data-insert-news-tag="h2">[h2]</button>
                      <button type="button" class="btn btn-outline" data-insert-news-tag="note">[note]</button>
                      <button type="button" class="btn btn-outline" data-insert-news-tag="ul">[ul]</button>
                      <button type="button" class="btn btn-outline" data-insert-news-tag="ol">[ol]</button>
                    </div>
                    <div class="hint">可在正文中插入图片标记：<code>[img:1|full]</code>、<code>[img:2|left]</code>、<code>[img:3|right]</code>。</div>
                    <div class="item-actions inline-marker-actions">
                      <button type="button" class="btn btn-outline" data-insert-news-img-marker data-marker-layout="full">[img:n|full]</button>
                      <button type="button" class="btn btn-outline" data-insert-news-img-marker data-marker-layout="left">[img:n|left]</button>
                      <button type="button" class="btn btn-outline" data-insert-news-img-marker data-marker-layout="right">[img:n|right]</button>
                    </div>
                    <div class="news-preview">
                      <p class="news-preview-title">正文实时预览</p>
                      <div class="news-preview-box" data-news-preview></div>
                    </div>
                  </div>
                </div>
                <div class="news-side-panel">
                  <div class="news-upload-card">
                    <label>图片（可选，多张）</label>
                    <input type="file" name="images" accept="image/*" multiple title="新闻图片">
                  </div>
                  <div class="news-upload-card">
                    <label>附件（可选，多个）</label>
                    <input type="file" name="attachments" multiple title="新闻附件">
                  </div>
                  <div class="news-upload-card">
                    <label>发布状态</label>
                    <label class="news-publish-check"><input type="checkbox" name="is_published" title="发布状态"> 立即发布</label>
                    <div class="hint">未勾选将保存为草稿，可在下方列表中再编辑并发布。</div>
                  </div>
                </div>
              </div>
              <div class="item-actions">
                <button class="btn" type="button" data-news-create>创建</button>
              </div>
            </div>
          </div>

          <div class="news-panel">
            <div class="news-panel-title">
              <h4>已创建ニュース</h4>
              <span class="hint">支持修改后保存或删除</span>
            </div>
            <div class="grid news-filter-form">
              <div>
                <label for="news_q">关键词检索</label>
                <input id="news_q" name="news_q" value="{{ news_q or '' }}" placeholder="标题/正文关键词">
              </div>
              <div>
                <label for="news_status">状态筛选</label>
                <select id="news_status" name="news_status" class="news-status-select">
                  <option value="all" {% if news_status == 'all' %}selected{% endif %}>全部</option>
                  <option value="published" {% if news_status == 'published' %}selected{% endif %}>已发布</option>
                  <option value="draft" {% if news_status == 'draft' %}selected{% endif %}>草稿</option>
                </select>
              </div>
              <div class="full item-actions news-filter-actions">
                <button class="btn btn-outline" type="button" data-news-filter-apply><i class="bi bi-search"></i> 检索</button>
                <button class="btn btn-outline" type="button" data-news-filter-clear><i class="bi bi-x-circle"></i> 清空</button>
                <span class="hint">当前结果：{{ news_total or 0 }} 条</span>
              </div>
            </div>
            {% if news_items and news_items|length > 0 %}
              <div class="news-list-wrap">
                {% for n in news_items %}
                  <div class="item-row news-item" data-news-id="{{ n.id }}" data-news-existing-images="{{ n.image_paths|length if n.image_paths else 0 }}">
                    <div class="news-meta">
                      <span class="badge">ID {{ n.id }}</span>
                      {% if n.is_published %}<span class="badge">公開中</span>{% else %}<span class="badge">非公開</span>{% endif %}
                      <span>详情页：<a href="/news/{{ n.id }}" target="_blank">/news/{{ n.id }}</a></span>
                    </div>
                    <div class="news-item-grid">
                      <div class="item-fields one">
                        <div>
                          <label>标题</label>
                          <input name="title" value="{{ n.title }}" title="新闻标题">
                        </div>
                        <div>
                          <label>正文</label>
                          <textarea name="body" class="textarea-tall" title="新闻正文">{{ n.body or '' }}</textarea>
                          <div class="hint">支持文本结构：<code>[h2]小标题[/h2]</code>、<code>[note]强调[/note]</code>、<code>[ul]要点1|要点2[/ul]</code>。</div>
                          <div class="news-editor-tools">
                            <button type="button" class="btn btn-outline" data-insert-news-tag="h2">[h2]</button>
                            <button type="button" class="btn btn-outline" data-insert-news-tag="note">[note]</button>
                            <button type="button" class="btn btn-outline" data-insert-news-tag="ul">[ul]</button>
                            <button type="button" class="btn btn-outline" data-insert-news-tag="ol">[ol]</button>
                          </div>
                          <div class="hint">可在正文中插入图片标记：<code>[img:1|full]</code>、<code>[img:2|left]</code>、<code>[img:3|right]</code>。</div>
                          <div class="item-actions inline-marker-actions">
                            <button type="button" class="btn btn-outline" data-insert-news-img-marker data-marker-layout="full">[img:n|full]</button>
                            <button type="button" class="btn btn-outline" data-insert-news-img-marker data-marker-layout="left">[img:n|left]</button>
                            <button type="button" class="btn btn-outline" data-insert-news-img-marker data-marker-layout="right">[img:n|right]</button>
                          </div>
                          <div class="news-preview">
                            <p class="news-preview-title">正文实时预览</p>
                            <div class="news-preview-box" data-news-preview></div>
                          </div>
                        </div>
                      </div>
                      <div class="news-side-fields">
                        <div class="news-upload-card">
                          <label>图片（多张）</label>
                          {% if n.image_paths and n.image_paths|length > 0 %}
                            <div class="hint">当前图片：</div>
                            {% for img in n.image_paths %}
                              <div class="hint"><a href="{{ img }}" target="_blank">图片 {{ loop.index }}</a></div>
                            {% endfor %}
                          {% endif %}
                          <input type="file" name="images" accept="image/*" multiple title="新闻图片">
                        </div>
                        <div class="news-upload-card">
                          <label>附件（多个）</label>
                          {% if n.file_paths and n.file_paths|length > 0 %}
                            <div class="hint">当前附件：</div>
                            {% for f in n.file_paths %}
                              <div class="hint"><a href="{{ f.url }}" target="_blank">{{ f.name }}</a></div>
                            {% endfor %}
                          {% endif %}
                          <input type="file" name="attachments" multiple title="新闻附件">
                        </div>
                        <div class="news-upload-card">
                          <label>发布状态</label>
                          <label class="news-publish-inline">
                            <input type="checkbox" name="is_published" title="发布状态" {% if n.is_published %}checked{% endif %}> 已发布
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="item-actions">
                      <button class="btn btn-outline" type="button" data-news-update>保存</button>
                      <button class="btn btn-danger" type="button" data-news-delete>删除</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <div class="item-actions news-pager">
                <a class="btn btn-outline {% if news_page <= 1 %}disabled{% endif %}" href="/admin?news_q={{ news_q or '' }}&news_status={{ news_status or 'all' }}&news_page={{ news_page - 1 }}">上一页</a>
                {% for p in news_page_numbers %}
                  <a class="btn {% if p == news_page %}btn{% else %}btn-outline{% endif %}" href="/admin?news_q={{ news_q or '' }}&news_status={{ news_status or 'all' }}&news_page={{ p }}">{{ p }}</a>
                {% endfor %}
                <a class="btn btn-outline {% if news_page >= news_total_pages %}disabled{% endif %}" href="/admin?news_q={{ news_q or '' }}&news_status={{ news_status or 'all' }}&news_page={{ news_page + 1 }}">下一页</a>
              </div>
            {% else %}
              <div class="hint">暂无新闻</div>
            {% endif %}
          </div>
        </div>
      </details>

      <details class="section" open>
        <summary><span class="section-title">Services</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="services_section_title">区块标题</label>
              <input id="services_section_title" name="services_section_title" value="{{ home.services_section_title or '' }}" placeholder="事業内容（Our Services）">
            </div>
            <div class="full">
              <label for="services_section_subtitle">区块描述</label>
              <textarea id="services_section_subtitle" name="services_section_subtitle">{{ home.services_section_subtitle or '' }}</textarea>
            </div>
          </div>
          <div class="full">
            <div class="hint">可新增/删除多条服务，每条包含「标题」「内容」「图标（可选）」「详情页正文」「多图」「多文件」。</div>
            <div id="servicesList">
              {% if services and services|length > 0 %}
                {% for s in services %}
                  <div class="item-row" data-service-existing-images="{{ s.detail_images|length if s.detail_images else 0 }}">
                    <div class="subpage-hint">子页面链接：<a href="/services/{{ loop.index0 }}" target="_blank">/services/{{ loop.index0 }}</a>（保存后生效）</div>
                    <div class="item-fields">
                      <div>
                        <label>标题</label>
                        <input name="services_title" value="{{ s.title }}" placeholder="例如：輸入事業（Import）">
                      </div>
                      <div>
                        <label>内容</label>
                        <textarea name="services_body" placeholder="服务内容">{{ s.body }}</textarea>
                      </div>
                      <div>
                        <label>图标（可选）</label>
                        <input name="services_icon" value="{{ s.icon or '' }}" placeholder="box-seam">
                      </div>
                    </div>
                    <div class="item-fields one">
                      <div>
                        <label>详情页正文（可选）</label>
                        <textarea name="services_detail_body" placeholder="这里填写子页面的详细介绍内容">{{ s.detail_body or '' }}</textarea>
                        <div class="hint">支持文本结构：<code>[h2]小标题[/h2]</code>、<code>[note]强调[/note]</code>、<code>[ul]要点1|要点2[/ul]</code>。</div>
                        <div class="news-editor-tools">
                          <button type="button" class="btn btn-outline" data-insert-service-tag="h2">[h2]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-tag="note">[note]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-tag="ul">[ul]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-tag="ol">[ol]</button>
                        </div>
                        <div class="hint">可在正文中插入图片标记：<code>[img:1|full]</code>、<code>[img:2|left]</code>、<code>[img:3|right]</code>。也支持商品跳转图：<code>[imglink:1|https://example.com/item|查看商品详情|left]</code>（布局可选：left/right/full）。</div>
                        <div class="item-actions inline-marker-actions">
                          <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="full">[img:n|full]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="left">[img:n|left]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="right">[img:n|right]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="full">[imglink:n|url|label|full]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="left">[imglink:n|url|label|left]</button>
                          <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="right">[imglink:n|url|label|right]</button>
                        </div>
                        <div class="news-preview">
                          <p class="news-preview-title">详情页正文实时预览</p>
                          <div class="news-preview-box" data-service-preview></div>
                        </div>
                      </div>
                    </div>
                    <div class="item-fields simple">
                      <div>
                        <label>详情页图片（可选，多张）</label>
                        <textarea name="services_detail_images" placeholder="每行一张图片 URL&#10;https://example.com/a.jpg&#10;https://example.com/b.jpg">{{ (s.detail_images or [])|join('\n') }}</textarea>
                        <div class="hint">也可直接上传本地图片（支持多选）</div>
                        <input type="file" accept="image/*" multiple data-services-images-upload title="上传详情页图片">
                      </div>
                      <div>
                        <label>详情页文件（可选，多个）</label>
                        <textarea name="services_detail_files" placeholder="每行一个文件，格式：名称|URL&#10;产品手册|https://example.com/manual.pdf&#10;报价单|https://example.com/quote.xlsx">{% if s.detail_files and s.detail_files|length > 0 %}{% for f in s.detail_files %}{{ (f.name or '文件') ~ '|' ~ (f.url or '') }}{% if not loop.last %}
{% endif %}{% endfor %}{% endif %}</textarea>
                        <div class="hint">也可直接上传本地文件（支持多选）</div>
                        <input type="file" multiple data-services-files-upload title="上传详情页文件">
                      </div>
                    </div>
                    <div class="item-actions">
                      <button type="button" class="btn btn-danger" data-remove>删除</button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="item-row" data-service-existing-images="0">
                  <div class="item-fields">
                    <div>
                      <label>标题</label>
                      <input name="services_title" value="" placeholder="例如：輸入事業（Import）">
                    </div>
                    <div>
                      <label>内容</label>
                      <textarea name="services_body" placeholder="服务内容"></textarea>
                    </div>
                    <div>
                      <label>图标（可选）</label>
                      <input name="services_icon" value="" placeholder="box-seam">
                    </div>
                  </div>
                  <div class="item-fields one">
                    <div>
                      <label>详情页正文（可选）</label>
                      <textarea name="services_detail_body" placeholder="这里填写子页面的详细介绍内容"></textarea>
                      <div class="hint">支持文本结构：<code>[h2]小标题[/h2]</code>、<code>[note]强调[/note]</code>、<code>[ul]要点1|要点2[/ul]</code>。</div>
                      <div class="news-editor-tools">
                        <button type="button" class="btn btn-outline" data-insert-service-tag="h2">[h2]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-tag="note">[note]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-tag="ul">[ul]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-tag="ol">[ol]</button>
                      </div>
                      <div class="hint">可在正文中插入图片标记：<code>[img:1|full]</code>、<code>[img:2|left]</code>、<code>[img:3|right]</code>。也支持商品跳转图：<code>[imglink:1|https://example.com/item|查看商品详情|left]</code>（布局可选：left/right/full）。</div>
                      <div class="item-actions inline-marker-actions">
                        <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="full">[img:n|full]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="left">[img:n|left]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="right">[img:n|right]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="full">[imglink:n|url|label|full]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="left">[imglink:n|url|label|left]</button>
                        <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="right">[imglink:n|url|label|right]</button>
                      </div>
                      <div class="news-preview">
                        <p class="news-preview-title">详情页正文实时预览</p>
                        <div class="news-preview-box" data-service-preview></div>
                      </div>
                    </div>
                  </div>
                  <div class="item-fields simple">
                    <div>
                      <label>详情页图片（可选，多张）</label>
                      <textarea name="services_detail_images" placeholder="每行一张图片 URL&#10;https://example.com/a.jpg&#10;https://example.com/b.jpg"></textarea>
                      <div class="hint">也可直接上传本地图片（支持多选）</div>
                      <input type="file" accept="image/*" multiple data-services-images-upload title="上传详情页图片">
                    </div>
                    <div>
                      <label>详情页文件（可选，多个）</label>
                      <textarea name="services_detail_files" placeholder="每行一个文件，格式：名称|URL&#10;产品手册|https://example.com/manual.pdf"></textarea>
                      <div class="hint">也可直接上传本地文件（支持多选）</div>
                      <input type="file" multiple data-services-files-upload title="上传详情页文件">
                    </div>
                  </div>
                  <div class="item-actions">
                    <button type="button" class="btn btn-danger" data-remove>删除</button>
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="item-actions">
              <button type="button" class="btn btn-outline" data-add-service>+ 添加服务</button>
            </div>
          </div>
        </div>
      </details>

      <details class="section" open>
        <summary><span class="section-title">Strengths</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="strengths_section_title">区块标题</label>
              <input id="strengths_section_title" name="strengths_section_title" value="{{ home.strengths_section_title or '' }}" placeholder="当社の強み（Why Choose Us?）">
            </div>
            <div class="full">
              <label for="strengths_section_subtitle">区块描述</label>
              <textarea id="strengths_section_subtitle" name="strengths_section_subtitle">{{ home.strengths_section_subtitle or '' }}</textarea>
            </div>
          </div>
          <div class="full">
            <div class="hint">可新增/删除多条强项，每条包含「标题」「内容」「图标（可选）」</div>
            <div id="strengthsList">
              {% if strengths and strengths|length > 0 %}
                {% for s in strengths %}
                  <div class="item-row">
                    <div class="item-fields">
                      <div>
                        <label>标题</label>
                        <input name="strengths_title" value="{{ s.title }}" placeholder="例如：独自のネットワーク">
                      </div>
                      <div>
                        <label>内容</label>
                        <textarea name="strengths_body" placeholder="强项内容">{{ s.body }}</textarea>
                      </div>
                      <div>
                        <label>图标（可选）</label>
                        <input name="strengths_icon" value="{{ s.icon or '' }}" placeholder="diagram-3-fill">
                      </div>
                    </div>
                    <div class="item-actions">
                      <button type="button" class="btn btn-danger" data-remove>删除</button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="item-row">
                  <div class="item-fields">
                    <div>
                      <label>标题</label>
                      <input name="strengths_title" value="" placeholder="例如：独自のネットワーク">
                    </div>
                    <div>
                      <label>内容</label>
                      <textarea name="strengths_body" placeholder="强项内容"></textarea>
                    </div>
                    <div>
                      <label>图标（可选）</label>
                      <input name="strengths_icon" value="" placeholder="diagram-3-fill">
                    </div>
                  </div>
                  <div class="item-actions">
                    <button type="button" class="btn btn-danger" data-remove>删除</button>
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="item-actions">
              <button type="button" class="btn btn-outline" data-add-strength>+ 添加强项</button>
            </div>
          </div>
        </div>
      </details>

      <details class="section" open>
        <summary><span class="section-title">公司概要</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="profile_title">区块标题</label>
              <input id="profile_title" name="profile_title" value="{{ home.profile_title or '' }}" placeholder="会社概要（Company Profile）">
            </div>
            <div class="full">
              <label for="profile_subtitle">区块描述</label>
              <textarea id="profile_subtitle" name="profile_subtitle">{{ home.profile_subtitle or '' }}</textarea>
            </div>
            <input id="company_name" name="company_name" value="{{ home.company_name or '' }}" hidden>
            <input id="established" name="established" value="{{ home.established or '' }}" hidden>
            <input id="address" name="address" value="{{ home.address or '' }}" hidden>
            <input id="representative" name="representative" value="{{ home.representative or '' }}" hidden>
            <textarea id="business_desc" name="business_desc" hidden>{{ home.business_desc or '' }}</textarea>
            <textarea id="clients" name="clients" hidden>{{ home.clients or '' }}</textarea>
            <div class="full">
              <h4>会社概要表格行（可新增/删除）</h4>
              <div class="hint">统一在这里编辑公司概要，避免重复维护。左侧为项目名，右侧为内容。</div>
              <div id="profileRowsList">
                {% if profile_rows and profile_rows|length > 0 %}
                  {% for row in profile_rows %}
                    <div class="item-row">
                      <div class="item-fields simple">
                        <div>
                          <label>项目名</label>
                          <input name="profile_row_label" value="{{ row.label or '' }}" placeholder="例如：所在地">
                        </div>
                        <div>
                          <label>内容</label>
                          <textarea name="profile_row_value" placeholder="例如：〒000-0000 東京都...">{{ row.value or '' }}</textarea>
                        </div>
                      </div>
                      <div class="item-actions">
                        <button type="button" class="btn btn-danger" data-remove>删除</button>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="item-row">
                    <div class="item-fields simple">
                      <div>
                        <label>项目名</label>
                        <input name="profile_row_label" value="名称" placeholder="例如：所在地">
                      </div>
                      <div>
                        <label>内容</label>
                        <textarea name="profile_row_value" placeholder="例如：〒000-0000 東京都...">{{ home.company_name or '' }}</textarea>
                      </div>
                    </div>
                    <div class="item-actions">
                      <button type="button" class="btn btn-danger" data-remove>删除</button>
                    </div>
                  </div>
                {% endif %}
              </div>
              <div class="item-actions">
                <button type="button" class="btn btn-outline" data-add-profile-row>+ 添加表格行</button>
              </div>
            </div>
          </div>
        </div>
      </details>

      <details class="section">
        <summary><span class="section-title">Contact / CTA</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="cta_title">CTA 标题</label>
              <input id="cta_title" name="cta_title" value="{{ home.cta_title or '' }}">
            </div>
            <div class="full">
              <label for="cta_subtitle">CTA 副标题</label>
              <textarea id="cta_subtitle" name="cta_subtitle">{{ home.cta_subtitle or '' }}</textarea>
            </div>
            <div>
              <label for="cta_button_text">CTA 按钮文案</label>
              <input id="cta_button_text" name="cta_button_text" value="{{ home.cta_button_text or '' }}">
            </div>
            <div>
              <label for="cta_phone_text">电话说明</label>
              <input id="cta_phone_text" name="cta_phone_text" value="{{ home.cta_phone_text or '' }}">
            </div>
            <div>
              <label for="contact_form_title">表单标题</label>
              <input id="contact_form_title" name="contact_form_title" value="{{ home.contact_form_title or '' }}">
            </div>
            <div>
              <label for="contact_examples_title">咨询示例标题</label>
              <input id="contact_examples_title" name="contact_examples_title" value="{{ home.contact_examples_title or '' }}">
            </div>
            <div class="full">
              <label for="contact_form_note">说明文字</label>
              <textarea id="contact_form_note" name="contact_form_note">{{ home.contact_form_note or '' }}</textarea>
            </div>
            <div class="full">
              <h4>咨询示例列表</h4>
              <div id="contactExamplesList">
                {% if contact_examples and contact_examples|length > 0 %}
                  {% for item in contact_examples %}
                    <div class="item-row">
                      <div class="item-fields one">
                        <div>
                          <label>示例</label>
                          <input name="contact_example_text" value="{{ item }}" placeholder="日本向け：カーアクセサリー...">
                        </div>
                      </div>
                      <div class="item-actions">
                        <button type="button" class="btn btn-danger" data-remove>删除</button>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="item-row">
                    <div class="item-fields one">
                      <div>
                        <label>示例</label>
                        <input name="contact_example_text" value="" placeholder="日本向け：カーアクセサリー...">
                      </div>
                    </div>
                    <div class="item-actions">
                      <button type="button" class="btn btn-danger" data-remove>删除</button>
                    </div>
                  </div>
                {% endif %}
              </div>
              <div class="item-actions">
                <button type="button" class="btn btn-outline" data-add-contact-example>+ 添加示例</button>
              </div>
            </div>
            <div>
              <label for="access_title">アクセス标题</label>
              <input id="access_title" name="access_title" value="{{ home.access_title or '' }}">
            </div>
            <div>
              <label for="access_address">アクセス地址</label>
              <input id="access_address" name="access_address" value="{{ home.access_address or '' }}">
            </div>
          </div>
        </div>
      </details>

      <details class="section">
        <summary><span class="section-title">Footer</span></summary>
        <div class="section-body">
          <div class="grid">
            <div class="full">
              <label for="footer_copyright">版权文案</label>
              <input id="footer_copyright" name="footer_copyright" value="{{ home.footer_copyright or '' }}">
            </div>
            <div>
              <label for="footer_link_top">底部链接：TOP</label>
              <input id="footer_link_top" name="footer_link_top" value="{{ home.footer_link_top or '' }}">
            </div>
            <div>
              <label for="footer_link_services">底部链接：Services</label>
              <input id="footer_link_services" name="footer_link_services" value="{{ home.footer_link_services or '' }}">
            </div>
            <div>
              <label for="footer_link_profile">底部链接：Profile</label>
              <input id="footer_link_profile" name="footer_link_profile" value="{{ home.footer_link_profile or '' }}">
            </div>
          </div>
        </div>
      </details>

      <div class="card form-actions">
        <button id="saveHomeBtn" class="btn save-btn" type="submit">
          <i class="bi bi-check2-circle"></i> 保存
        </button>
        <div class="save-note">保存后前端刷新即可看到变化（前端需接入 API 渲染）。</div>
      </div>
    </form>
  </div>
  <div id="toastStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <template id="serviceItemTpl">
    <div class="item-row" data-service-existing-images="0">
      <div class="item-fields">
        <div>
          <label>标题</label>
          <input name="services_title" value="" placeholder="例如：輸入事業（Import）" title="服务标题">
        </div>
        <div>
          <label>内容</label>
          <textarea name="services_body" placeholder="服务内容" title="服务内容"></textarea>
        </div>
        <div>
          <label>图标（可选）</label>
          <input name="services_icon" value="" placeholder="box-seam" title="Bootstrap Icons 名称">
        </div>
      </div>
      <div class="item-fields one">
        <div>
          <label>详情页正文（可选）</label>
          <textarea name="services_detail_body" placeholder="这里填写子页面的详细介绍内容" title="详情页正文"></textarea>
          <div class="hint">支持文本结构：<code>[h2]小标题[/h2]</code>、<code>[note]强调[/note]</code>、<code>[ul]要点1|要点2[/ul]</code>。</div>
          <div class="news-editor-tools">
            <button type="button" class="btn btn-outline" data-insert-service-tag="h2">[h2]</button>
            <button type="button" class="btn btn-outline" data-insert-service-tag="note">[note]</button>
            <button type="button" class="btn btn-outline" data-insert-service-tag="ul">[ul]</button>
            <button type="button" class="btn btn-outline" data-insert-service-tag="ol">[ol]</button>
          </div>
          <div class="hint">可在正文中插入图片标记：<code>[img:1|full]</code>、<code>[img:2|left]</code>、<code>[img:3|right]</code>。也支持商品跳转图：<code>[imglink:1|https://example.com/item|查看商品详情|left]</code>（布局可选：left/right/full）。</div>
          <div class="item-actions inline-marker-actions">
            <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="full">[img:n|full]</button>
            <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="left">[img:n|left]</button>
            <button type="button" class="btn btn-outline" data-insert-service-img-marker data-marker-layout="right">[img:n|right]</button>
            <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="full">[imglink:n|url|label|full]</button>
            <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="left">[imglink:n|url|label|left]</button>
            <button type="button" class="btn btn-outline" data-insert-service-img-link-marker data-marker-layout="right">[imglink:n|url|label|right]</button>
          </div>
          <div class="news-preview">
            <p class="news-preview-title">详情页正文实时预览</p>
            <div class="news-preview-box" data-service-preview></div>
          </div>
        </div>
      </div>
      <div class="item-fields simple">
        <div>
          <label>详情页图片（可选，多张）</label>
          <textarea name="services_detail_images" placeholder="每行一张图片 URL&#10;https://example.com/a.jpg&#10;https://example.com/b.jpg" title="详情页图片"></textarea>
          <div class="hint">也可直接上传本地图片（支持多选）</div>
          <input type="file" accept="image/*" multiple data-services-images-upload title="上传详情页图片">
        </div>
        <div>
          <label>详情页文件（可选，多个）</label>
          <textarea name="services_detail_files" placeholder="每行一个文件，格式：名称|URL&#10;产品手册|https://example.com/manual.pdf" title="详情页文件"></textarea>
          <div class="hint">也可直接上传本地文件（支持多选）</div>
          <input type="file" multiple data-services-files-upload title="上传详情页文件">
        </div>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger" data-remove>删除</button>
      </div>
    </div>
  </template>

  <template id="strengthItemTpl">
    <div class="item-row">
      <div class="item-fields">
        <div>
          <label>标题</label>
          <input name="strengths_title" value="" placeholder="例如：独自のネットワーク" title="强项标题">
        </div>
        <div>
          <label>内容</label>
          <textarea name="strengths_body" placeholder="强项内容" title="强项内容"></textarea>
        </div>
        <div>
          <label>图标（可选）</label>
          <input name="strengths_icon" value="" placeholder="diagram-3-fill" title="Bootstrap Icons 名称">
        </div>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger" data-remove>删除</button>
      </div>
    </div>
  </template>

  <template id="heroStatItemTpl">
    <div class="item-row">
      <div class="item-fields compact">
        <div>
          <label>数字</label>
          <input name="hero_stat_value" value="" placeholder="2">
        </div>
        <div>
          <label>后缀</label>
          <input name="hero_stat_suffix" value="" placeholder="国間">
        </div>
        <div>
          <label>说明</label>
          <input name="hero_stat_label" value="" placeholder="日中の調達・販売を一気通貫">
        </div>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger" data-remove>删除</button>
      </div>
    </div>
  </template>

  <template id="conceptPointTpl">
    <div class="item-row">
      <div class="item-fields simple">
        <div>
          <label>标题</label>
          <input name="concept_point_label" value="" placeholder="安心">
        </div>
        <div>
          <label>说明</label>
          <textarea name="concept_point_body" placeholder="検品・規格・品質の可視化"></textarea>
        </div>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger" data-remove>删除</button>
      </div>
    </div>
  </template>

  <template id="presidentPointTpl">
    <div class="item-row">
      <div class="item-fields one">
        <div>
          <label>要点</label>
          <input name="president_point_text" value="" placeholder="例如：長期的な信頼関係を重視">
        </div>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger" data-remove>删除</button>
      </div>
    </div>
  </template>

  <template id="contactExampleTpl">
    <div class="item-row">
      <div class="item-fields one">
        <div>
          <label>示例</label>
          <input name="contact_example_text" value="" placeholder="日本向け：カーアクセサリー...">
        </div>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger" data-remove>删除</button>
      </div>
    </div>
  </template>

  <template id="profileRowTpl">
    <div class="item-row">
      <div class="item-fields simple">
        <div>
          <label>项目名</label>
          <input name="profile_row_label" value="" placeholder="例如：所在地">
        </div>
        <div>
          <label>内容</label>
          <textarea name="profile_row_value" placeholder="例如：〒000-0000 東京都..."></textarea>
        </div>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger" data-remove>删除</button>
      </div>
    </div>
  </template>

  <script>
    (() => {
      const canvas = document.getElementById("networkCanvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      const state = {
        w: 0,
        h: 0,
        nodes: [],
        maxDist: 145,
        mouse: { x: -9999, y: -9999, active: false },
      };

      const resize = () => {
        state.w = window.innerWidth;
        state.h = window.innerHeight;
        canvas.width = Math.floor(state.w * dpr);
        canvas.height = Math.floor(state.h * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        const density = Math.max(34, Math.floor((state.w * state.h) / 30000));
        state.nodes = Array.from({ length: density }, () => ({
          x: Math.random() * state.w,
          y: Math.random() * state.h,
          vx: (Math.random() - 0.5) * 0.5,
          vy: (Math.random() - 0.5) * 0.5,
          r: Math.random() * 1.8 + 0.7,
        }));
      };

      const onMove = (e) => {
        state.mouse.x = e.clientX;
        state.mouse.y = e.clientY;
        state.mouse.active = true;
      };

      const draw = () => {
        ctx.clearRect(0, 0, state.w, state.h);
        const nodes = state.nodes;
        for (let i = 0; i < nodes.length; i++) {
          const n = nodes[i];
          if (!prefersReducedMotion) {
            n.x += n.vx;
            n.y += n.vy;
          }

          if (n.x < -20) n.x = state.w + 20;
          if (n.x > state.w + 20) n.x = -20;
          if (n.y < -20) n.y = state.h + 20;
          if (n.y > state.h + 20) n.y = -20;

          if (state.mouse.active) {
            const dxm = state.mouse.x - n.x;
            const dym = state.mouse.y - n.y;
            const dm = Math.hypot(dxm, dym);
            if (dm < 130 && dm > 0.001) {
              const pull = (130 - dm) / 130;
              n.x -= (dxm / dm) * pull * 0.5;
              n.y -= (dym / dm) * pull * 0.5;
            }
          }

          for (let j = i + 1; j < nodes.length; j++) {
            const m = nodes[j];
            const dx = n.x - m.x;
            const dy = n.y - m.y;
            const dist = Math.hypot(dx, dy);
            if (dist > state.maxDist) continue;
            const alpha = 1 - dist / state.maxDist;
            ctx.beginPath();
            ctx.moveTo(n.x, n.y);
            ctx.lineTo(m.x, m.y);
            ctx.strokeStyle = `rgba(64,120,190,${0.12 * alpha})`;
            ctx.lineWidth = 1;
            ctx.stroke();
          }
        }

        for (const n of nodes) {
          ctx.beginPath();
          ctx.arc(n.x, n.y, n.r, 0, Math.PI * 2);
          ctx.fillStyle = "rgba(31,89,160,0.48)";
          ctx.fill();
          ctx.beginPath();
          ctx.arc(n.x, n.y, n.r + 1.8, 0, Math.PI * 2);
          ctx.fillStyle = "rgba(110,164,226,0.08)";
          ctx.fill();
        }

        requestAnimationFrame(draw);
      };

      resize();
      window.addEventListener("resize", resize);
      window.addEventListener("mousemove", onMove);
      window.addEventListener("touchmove", (e) => {
        if (!e.touches || e.touches.length === 0) return;
        const t = e.touches[0];
        onMove({ clientX: t.clientX, clientY: t.clientY });
      }, { passive: true });
      window.addEventListener("mouseleave", () => { state.mouse.active = false; });
      draw();
    })();

    const addItem = (listId, tplId) => {
      const list = document.getElementById(listId);
      const tpl = document.getElementById(tplId);
      if (!list || !tpl) return;
      const node = tpl.content.firstElementChild.cloneNode(true);
      list.appendChild(node);
      return node;
    };

    const insertAtCursor = (textarea, text) => {
      if (!textarea) return;
      const start = textarea.selectionStart ?? textarea.value.length;
      const end = textarea.selectionEnd ?? textarea.value.length;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = `${before}${text}${after}`;
      const nextPos = start + text.length;
      textarea.focus();
      textarea.setSelectionRange(nextPos, nextPos);
    };

    const nextImageMarkerNo = (textarea) => {
      const value = textarea?.value || "";
      const matches = value.match(/\[img:(\d+)(?:\|(left|right|full))?\]|\{\{img:(\d+)(?:\|(left|right|full))?\}\}|\[imglink:(\d+)\|[^\]]+\]|\{\{imglink:(\d+)\|[^}]+\}\}/gi) || [];
      return matches.length + 1;
    };
    const escapeHtml = (text) => String(text || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
    const newsTokenRegex = /\{\{img:(\d+)(?:\|(left|right|full))?\}\}|\[img:(\d+)(?:\|(left|right|full))?\]|\{\{imglink:(\d+)\|([^|}\n]+)(?:\|([^|}\n]+))?(?:\|(left|right|full))?\}\}|\[imglink:(\d+)\|([^\|\]\n]+)(?:\|([^\|\]\n]+))?(?:\|(left|right|full))?\]|\[h2\](.*?)\[\/h2\]|\[note\](.*?)\[\/note\]|\[ul\](.*?)\[\/ul\]|\[ol\](.*?)\[\/ol\]/gis;
    const parseNewsBlocks = (body) => {
      const text = String(body || "").replaceAll("\r\n", "\n");
      const blocks = [];
      let cursor = 0;
      for (const m of text.matchAll(newsTokenRegex)) {
        const start = m.index ?? 0;
        const before = text.slice(cursor, start).trim();
        if (before) blocks.push({ type: "text", value: before });
        const imgNoRaw = m[1] || m[3];
        if (imgNoRaw != null) {
          const layout = ((m[2] || m[4] || "full") + "").toLowerCase();
          blocks.push({ type: "image", no: Number(imgNoRaw), layout: ["left", "right", "full"].includes(layout) ? layout : "full" });
          cursor = start + m[0].length;
          continue;
        }
        const linkImgNoRaw = m[5] || m[9];
        if (linkImgNoRaw != null) {
          const url = String(m[6] || m[10] || "").trim();
          const label = String(m[7] || m[11] || "查看商品详情").trim() || "查看商品详情";
          const layoutRaw = String(m[8] || m[12] || "full").trim().toLowerCase();
          const layout = ["left", "right", "full"].includes(layoutRaw) ? layoutRaw : "full";
          blocks.push({ type: "image_link", no: Number(linkImgNoRaw), linkUrl: url, linkLabel: label, layout });
          cursor = start + m[0].length;
          continue;
        }
        if (m[13] != null) { blocks.push({ type: "heading", value: String(m[13]).trim() }); cursor = start + m[0].length; continue; }
        if (m[14] != null) { blocks.push({ type: "note", value: String(m[14]).trim() }); cursor = start + m[0].length; continue; }
        if (m[15] != null) {
          const items = String(m[15]).split("|").map((x) => x.trim()).filter(Boolean);
          if (items.length) blocks.push({ type: "list", ordered: false, items });
          cursor = start + m[0].length;
          continue;
        }
        if (m[16] != null) {
          const items = String(m[16]).split("|").map((x) => x.trim()).filter(Boolean);
          if (items.length) blocks.push({ type: "list", ordered: true, items });
          cursor = start + m[0].length;
          continue;
        }
        cursor = start + m[0].length;
      }
      const tail = text.slice(cursor).trim();
      if (tail) blocks.push({ type: "text", value: tail });
      return blocks;
    };
    const buildNewsPreviewHtml = (body) => {
      const blocks = parseNewsBlocks(body);
      if (!blocks.length) {
        return '<div class="news-preview-empty">在正文输入内容后，这里会显示排版预览。</div>';
      }
      return blocks.map((block) => {
        if (block.type === "heading") return `<h4 class="news-preview-h2">${escapeHtml(block.value)}</h4>`;
        if (block.type === "note") return `<p class="news-preview-note">${escapeHtml(block.value)}</p>`;
        if (block.type === "list") {
          const tag = block.ordered ? "ol" : "ul";
          const items = block.items.map((li) => `<li>${escapeHtml(li)}</li>`).join("");
          return `<${tag} class="news-preview-list">${items}</${tag}>`;
        }
        if (block.type === "image_link") return `<div class="news-preview-img">商品跳转图：第 ${Math.max(1, Number(block.no) || 1)} 张（${escapeHtml(block.layout || "full")}）→ ${escapeHtml(block.linkUrl || "#")}（${escapeHtml(block.linkLabel || "查看商品详情")}）</div>`;
        if (block.type === "image") return `<div class="news-preview-img">图片占位：第 ${Math.max(1, Number(block.no) || 1)} 张（${escapeHtml(block.layout || "full")}）</div>`;
        return `<p>${escapeHtml(block.value)}</p>`;
      }).join("");
    };
    const refreshNewsPreview = (root) => {
      if (!root) return;
      const area = root.querySelector('textarea[name="body"]');
      const preview = root.querySelector("[data-news-preview]");
      if (!area || !preview) return;
      preview.innerHTML = buildNewsPreviewHtml(area.value || "");
    };
    const markerMaxIndex = (body) => {
      const matches = String(body || "").matchAll(/\[img:(\d+)(?:\|(left|right|full))?\]|\{\{img:(\d+)(?:\|(left|right|full))?\}\}/gi);
      let maxNo = 0;
      for (const m of matches) {
        const raw = m[1] || m[3];
        const n = Number(raw || 0);
        if (Number.isFinite(n) && n > maxNo) maxNo = n;
      }
      const linkMatches = String(body || "").matchAll(/\[imglink:(\d+)\|[^\]]+\]|\{\{imglink:(\d+)\|[^}]+\}\}/gi);
      for (const m of linkMatches) {
        const raw = m[1] || m[2];
        const n = Number(raw || 0);
        if (Number.isFinite(n) && n > maxNo) maxNo = n;
      }
      return maxNo;
    };
    const insertNewsTag = (textarea, tag) => {
      if (!textarea) return;
      const templates = {
        h2: "\n[h2]小标题[/h2]\n",
        note: "\n[note]这里写强调内容[/note]\n",
        ul: "\n[ul]要点1|要点2|要点3[/ul]\n",
        ol: "\n[ol]步骤1|步骤2|步骤3[/ol]\n",
      };
      insertAtCursor(textarea, templates[tag] || "");
    };
    const insertServiceTag = (textarea, tag) => {
      if (!textarea) return;
      const templates = {
        h2: "\n[h2]小标题[/h2]\n",
        note: "\n[note]这里写强调内容[/note]\n",
        ul: "\n[ul]要点1|要点2|要点3[/ul]\n",
        ol: "\n[ol]步骤1|步骤2|步骤3[/ol]\n",
      };
      insertAtCursor(textarea, templates[tag] || "");
    };
    const insertServiceImageLinkMarker = (textarea, markerNo, layout = "full") => {
      if (!textarea) return;
      insertAtCursor(textarea, `\n[imglink:${markerNo}|https://example.com/product/${markerNo}|查看商品详情|${layout}]\n`);
    };
    const buildServicePreviewHtml = (body) => {
      const blocks = parseNewsBlocks(body);
      if (!blocks.length) {
        return '<div class="news-preview-empty">在详情页正文输入内容后，这里会显示排版预览。</div>';
      }
      return blocks.map((block) => {
        if (block.type === "heading") return `<h4 class="news-preview-h2">${escapeHtml(block.value)}</h4>`;
        if (block.type === "note") return `<p class="news-preview-note">${escapeHtml(block.value)}</p>`;
        if (block.type === "list") {
          const tag = block.ordered ? "ol" : "ul";
          const items = block.items.map((li) => `<li>${escapeHtml(li)}</li>`).join("");
          return `<${tag} class="news-preview-list">${items}</${tag}>`;
        }
        if (block.type === "image_link") return `<div class="news-preview-img">商品跳转图：第 ${Math.max(1, Number(block.no) || 1)} 张（${escapeHtml(block.layout || "full")}）→ ${escapeHtml(block.linkUrl || "#")}（${escapeHtml(block.linkLabel || "查看商品详情")}）</div>`;
        if (block.type === "image") return `<div class="news-preview-img">插图占位：第 ${Math.max(1, Number(block.no) || 1)} 张（${escapeHtml(block.layout || "full")}）</div>`;
        return `<p>${escapeHtml(block.value)}</p>`;
      }).join("");
    };
    const refreshServicePreview = (root) => {
      if (!root) return;
      const area = root.querySelector('textarea[name="services_detail_body"]');
      const preview = root.querySelector("[data-service-preview]");
      if (!area || !preview) return;
      preview.innerHTML = buildServicePreviewHtml(area.value || "");
    };
    const countServiceImages = (root) => {
      const area = root?.querySelector('textarea[name="services_detail_images"]');
      if (!area) return 0;
      return String(area.value || "")
        .replaceAll("，", ",")
        .replaceAll(",", "\n")
        .split("\n")
        .map((x) => x.trim())
        .filter(Boolean).length;
    };
    const validateServiceRows = () => {
      const rows = document.querySelectorAll("#servicesList .item-row");
      for (const row of rows) {
        const body = row.querySelector('textarea[name="services_detail_body"]')?.value || "";
        const markerNo = markerMaxIndex(body);
        const existingCount = Number(row.getAttribute("data-service-existing-images") || "0");
        const imageCount = countServiceImages(row);
        const available = Math.max(existingCount, imageCount);
        if (markerNo > available) {
          return `服务详情正文引用了第 ${markerNo} 张图片，但当前仅有 ${available} 张可用图片。请检查图片标记或补充图片。`;
        }
      }
      return "";
    };

    const toastStack = document.getElementById("toastStack");
    const showToast = (type, title, message) => {
      if (!toastStack) return;
      const toast = document.createElement("div");
      toast.className = `toast-msg ${type === "ok" ? "ok" : "err"}`;
      toast.innerHTML = `
        <div class="toast-title">
          <i class="bi ${type === "ok" ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill"}"></i>
          <span>${title}</span>
        </div>
        <p class="toast-body">${message || ""}</p>
      `;
      toastStack.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateY(8px)";
        setTimeout(() => toast.remove(), 180);
      }, 5000);
    };

    const readParamToast = () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get("success") === "1") {
        showToast("ok", "保存成功", "已成功保存页面配置。");
      }
      const err = params.get("error");
      if (err) {
        showToast("err", "保存失败", err);
      }
    };
    readParamToast();

    const saveForm = document.querySelector('form[action="/admin/save"]');
    const saveBtn = document.getElementById("saveHomeBtn");
    if (saveForm) {
      saveForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const serviceErr = validateServiceRows();
        if (serviceErr) {
          showToast("err", "保存失败", serviceErr);
          return;
        }
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> 保存中...';
        }
        try {
          const res = await fetch("/admin/save", {
            method: "POST",
            body: new FormData(saveForm),
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "Accept": "application/json",
            },
          });
          let data = null;
          try {
            data = await res.json();
          } catch (_) {
            data = null;
          }
          if (res.ok && data?.ok) {
            showToast("ok", "保存成功", data?.message || "配置已保存。");
          } else {
            const reason = (data?.detail || data?.message || "未知错误").toString().slice(0, 220);
            showToast("err", "保存失败", reason);
          }
        } catch (err) {
          showToast("err", "保存失败", (err?.message || "网络异常，请稍后重试").toString().slice(0, 220));
        } finally {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check2-circle"></i> 保存';
          }
        }
      });
    }

    document.addEventListener("click", (e) => {
      const el = e.target instanceof Element ? e.target : null;
      if (!el) return;

      if (el.closest("[data-add-service]")) {
        const node = addItem("servicesList", "serviceItemTpl");
        refreshServicePreview(node);
      }
      if (el.closest("[data-add-strength]")) {
        addItem("strengthsList", "strengthItemTpl");
      }
      if (el.closest("[data-add-hero-stat]")) {
        addItem("heroStatsList", "heroStatItemTpl");
      }
      if (el.closest("[data-add-concept-point]")) {
        addItem("conceptPointsList", "conceptPointTpl");
      }
      if (el.closest("[data-add-president-point]")) {
        addItem("presidentPointsList", "presidentPointTpl");
      }
      if (el.closest("[data-add-contact-example]")) {
        addItem("contactExamplesList", "contactExampleTpl");
      }
      if (el.closest("[data-add-profile-row]")) {
        addItem("profileRowsList", "profileRowTpl");
      }
      if (el.closest("[data-insert-service-img-marker]")) {
        const row = el.closest(".item-row");
        const area = row?.querySelector('textarea[name="services_detail_body"]');
        if (!area) return;
        const markerNo = nextImageMarkerNo(area);
        const layout = (el.getAttribute("data-marker-layout") || "full").toLowerCase();
        insertAtCursor(area, `\n[img:${markerNo}|${layout}]\n`);
        refreshServicePreview(row);
      }
      if (el.closest("[data-insert-service-img-link-marker]")) {
        const row = el.closest(".item-row");
        const area = row?.querySelector('textarea[name="services_detail_body"]');
        if (!area) return;
        const markerNo = nextImageMarkerNo(area);
        const layout = (el.getAttribute("data-marker-layout") || "full").toLowerCase();
        insertServiceImageLinkMarker(area, markerNo, layout);
        refreshServicePreview(row);
      }
      if (el.closest("[data-insert-service-tag]")) {
        const row = el.closest(".item-row");
        const area = row?.querySelector('textarea[name="services_detail_body"]');
        const tag = (el.getAttribute("data-insert-service-tag") || "").toLowerCase();
        if (!area || !tag) return;
        insertServiceTag(area, tag);
        refreshServicePreview(row);
      }
      if (el.closest("[data-insert-news-img-marker]")) {
        const root = el.closest(".news-item, .news-create");
        const area = root?.querySelector('textarea[name="body"]');
        if (!area) return;
        const markerNo = nextImageMarkerNo(area);
        const layout = (el.getAttribute("data-marker-layout") || "full").toLowerCase();
        insertAtCursor(area, `\n[img:${markerNo}|${layout}]\n`);
        refreshNewsPreview(root);
      }
      if (el.closest("[data-insert-news-tag]")) {
        const root = el.closest(".news-item, .news-create");
        const area = root?.querySelector('textarea[name="body"]');
        const tag = (el.getAttribute("data-insert-news-tag") || "").toLowerCase();
        if (!area || !tag) return;
        insertNewsTag(area, tag);
        refreshNewsPreview(root);
      }
      if (el.closest("[data-news-filter-apply]")) {
        const q = document.getElementById("news_q")?.value?.trim() || "";
        const status = document.getElementById("news_status")?.value || "all";
        const params = new URLSearchParams();
        if (q) params.set("news_q", q);
        if (status && status !== "all") params.set("news_status", status);
        params.set("news_page", "1");
        window.location.href = `/admin?${params.toString()}`;
      }
      if (el.closest("[data-news-filter-clear]")) {
        window.location.href = "/admin";
      }
      if (el.closest("[data-remove]")) {
        const row = el.closest(".item-row");
        if (row) row.remove();
      }
      if (el.closest("[data-news-create]")) {
        const root = el.closest(".news-create");
        if (!root) return;
        submitNewsForm("/admin/news/create", root);
      }
      if (el.closest("[data-news-update]")) {
        const root = el.closest(".news-item");
        if (!root) return;
        const id = root.getAttribute("data-news-id");
        if (!id) return;
        submitNewsForm(`/admin/news/update/${id}`, root);
      }
      if (el.closest("[data-news-delete]")) {
        const root = el.closest(".news-item");
        if (!root) return;
        const id = root.getAttribute("data-news-id");
        if (!id) return;
        if (!confirm("确定删除此新闻吗？")) return;
        fetch(`/admin/news/delete/${id}`, { method: "POST" })
          .then(() => window.location.reload())
          .catch(() => alert("删除失败，请稍后再试"));
      }
    });

    const appendLines = (textarea, lines) => {
      if (!textarea || !Array.isArray(lines) || lines.length === 0) return;
      const current = (textarea.value || "").trim();
      const next = lines.join("\n");
      textarea.value = current ? `${current}\n${next}` : next;
    };

    const uploadServiceAssets = async (input, kind) => {
      const root = input.closest(".item-row");
      if (!root) return;
      const files = Array.from(input.files || []);
      if (files.length === 0) return;

      const fd = new FormData();
      fd.append("kind", kind);
      files.forEach((file) => fd.append("files", file));

      input.disabled = true;
      try {
        const res = await fetch("/admin/services/upload", {
          method: "POST",
          body: fd
        });
        const raw = await res.text();
        let data = null;
        try {
          data = JSON.parse(raw);
        } catch (_) {
          data = null;
        }
        if (!res.ok || !data?.ok || !Array.isArray(data.items)) {
          const msg = (data?.detail || raw || "上传失败，请稍后再试").toString().slice(0, 260);
          alert(msg);
          return;
        }

        if (kind === "image") {
          const area = root.querySelector('textarea[name="services_detail_images"]');
          appendLines(area, data.items.map((item) => item.url).filter(Boolean));
          const latestCount = countServiceImages(root);
          root.setAttribute("data-service-existing-images", String(latestCount));
        } else {
          const area = root.querySelector('textarea[name="services_detail_files"]');
          appendLines(area, data.items.map((item) => `${item.name || "文件"}|${item.url || ""}`));
        }
        refreshServicePreview(root);
      } catch (err) {
        const message = (err?.message || "上传失败，请稍后再试").toString().slice(0, 260);
        alert(message);
      } finally {
        input.disabled = false;
        input.value = "";
      }
    };

    document.addEventListener("change", (e) => {
      const el = e.target instanceof Element ? e.target : null;
      if (!el) return;
      if (el.matches("[data-services-images-upload]")) {
        uploadServiceAssets(el, "image");
      }
      if (el.matches("[data-services-files-upload]")) {
        uploadServiceAssets(el, "file");
      }
      if (el.matches('.item-row textarea[name="services_detail_body"], .item-row textarea[name="services_detail_images"]')) {
        const row = el.closest(".item-row");
        if (el.matches('textarea[name="services_detail_images"]')) {
          const latestCount = countServiceImages(row);
          row?.setAttribute("data-service-existing-images", String(latestCount));
        }
        refreshServicePreview(row);
      }
      if (el.matches('.news-item textarea[name="body"], .news-create textarea[name="body"], .news-item input[name="images"], .news-create input[name="images"]')) {
        const root = el.closest(".news-item, .news-create");
        refreshNewsPreview(root);
      }
    });

    document.addEventListener("input", (e) => {
      const el = e.target instanceof Element ? e.target : null;
      if (!el) return;
      if (el.matches('.news-item textarea[name="body"], .news-create textarea[name="body"]')) {
        const root = el.closest(".news-item, .news-create");
        refreshNewsPreview(root);
      }
      if (el.matches('.item-row textarea[name="services_detail_body"], .item-row textarea[name="services_detail_images"]')) {
        const row = el.closest(".item-row");
        if (el.matches('textarea[name="services_detail_images"]')) {
          const latestCount = countServiceImages(row);
          row?.setAttribute("data-service-existing-images", String(latestCount));
        }
        refreshServicePreview(row);
      }
    });


    const submitNewsForm = (url, root) => {
      const title = root.querySelector('input[name="title"]')?.value?.trim() || "";
      if (!title) {
        alert("请填写标题");
        return;
      }
      const fd = new FormData();
      fd.append("title", title);
      const body = root.querySelector('textarea[name="body"]')?.value || "";
      const bodyPlain = body
        .replace(/\{\{img:(\d+)(?:\|(left|right|full))?\}\}|\[img:(\d+)(?:\|(left|right|full))?\]/gi, "")
        .replace(/\[h2\](.*?)\[\/h2\]|\[note\](.*?)\[\/note\]|\[ul\](.*?)\[\/ul\]|\[ol\](.*?)\[\/ol\]/gis, "$1$2$3$4")
        .trim();
      if (bodyPlain.length < 8) {
        alert("正文内容太短，请至少填写一段有效文本。");
        return;
      }
      fd.append("body", body);
      const images = Array.from(root.querySelector('input[name="images"]')?.files || []);
      const attachments = Array.from(root.querySelector('input[name="attachments"]')?.files || []);
      const existingImageCount = Number(root.getAttribute("data-news-existing-images") || "0");
      const availableImages = Math.max(0, existingImageCount) + images.length;
      const maxMarkerNo = markerMaxIndex(body);
      if (maxMarkerNo > availableImages) {
        alert(`正文中引用了第 ${maxMarkerNo} 张图片，但当前可用图片只有 ${availableImages} 张，请检查图片标记。`);
        return;
      }
      images.forEach((file) => fd.append("images", file));
      attachments.forEach((file) => fd.append("attachments", file));
      const isPublished = root.querySelector('input[name="is_published"]')?.checked;
      if (isPublished) fd.append("is_published", "on");
      fetch(url, { method: "POST", body: fd })
        .then(() => window.location.reload())
        .catch(() => alert("提交失败，请稍后再试"));
    };
    document.querySelectorAll(".news-item, .news-create").forEach((root) => refreshNewsPreview(root));
    document.querySelectorAll("#servicesList .item-row").forEach((row) => {
      const currentCount = countServiceImages(row);
      if (currentCount > 0) row.setAttribute("data-service-existing-images", String(currentCount));
      refreshServicePreview(row);
    });
  </script>
</body>
</html>
